<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Barcode & QR Code Generator — PDF Output</title>
<style>
body { font-family: Arial, sans-serif; background: #f8fafc; margin: 0; padding: 0; }
header { background: #0f172a; color: white; padding: 1rem; text-align: center; display:flex; gap:.5rem; align-items:center; justify-content:center; }
header svg { width:32px; height:32px; fill:white; }
main { max-width:1000px; margin:auto; padding:2rem; }
.controls { display:flex; flex-wrap:wrap; gap:1rem; justify-content:center; margin-bottom:1rem; }
.btn { background:#2563eb; color:white; border:none; padding:.6rem 1rem; border-radius:8px; cursor:pointer; }
.btn:hover { background:#1e40af; }
.clear-btn { background:#ef4444; }
.clear-btn:hover { background:#b91c1c; }
input[type=file] { display:none; }
label.upload-label { background:#2563eb; color:white; padding:.6rem 1rem; border-radius:8px; cursor:pointer; }
.form-inline { display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; margin-bottom:1rem; }
.form-inline input, select { padding:.4rem; border:1px solid #cbd5e1; border-radius:6px; font-size:.9rem; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:20px; margin-top:2rem; }
.card { background:white; border-radius:12px; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; position:relative; }
.delete-btn { position:absolute; top:5px; right:5px; background:#ef4444; border:none; border-radius:50%; width:24px; height:24px; color:white; font-weight:bold; cursor:pointer; }
.card svg { max-width:100%; height:auto; display:block; margin:auto; }
</style>

<!-- Libraries -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<header>
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 4h1v16H3zm2 0h2v16H5zm3 0h1v16H8zm2 0h3v16h-3zm4 0h1v16h-1zm2 0h2v16h-2zm3 0h1v16h-1zm2 0h1v16h-1z"/></svg>
<h1>Barcode & QR Code Generator (PDF)</h1>
</header>
<main>
<div class="controls">
<label class="upload-label" for="csvFile">Upload CSV</label>
<input id="csvFile" type="file" accept=".csv" />
<button class="btn" onclick="downloadTemplate()">Download Template</button>
<button class="btn" onclick="downloadAllPDFs()">Download All Individually (PDF)</button>

</div>
<div class="form-inline">
<label>Type:
<select id="typeSelect">
<option value="barcode">Barcode</option>
<option value="qrcode">QR Code</option>
</select>
</label>
</div>
<div class="form-inline">
<input id="manualName" type="text" placeholder="Name" />
<input id="manualCode" type="text" placeholder="Code" />
<button class="btn" onclick="addManual()">Add</button>
<button class="btn clear-btn" onclick="clearAll()">Clear All</button>
</div>
<div class="form-inline">
<label>Barcode Width (mm): <input id="widthMm" type="number" value="55" min="10" /></label>
<label>Barcode Height (mm): <input id="heightMm" type="number" value="11" min="5" /></label>
<label>QR Size (mm): <input id="qrSizeMm" type="number" value="55" min="10" /></label>
<label><input id="showText" type="checkbox" checked /> Show text below barcode</label>
<label><input id="nameWithCode" type="checkbox" /> Name & Code in filename</label>
</div>
<div id="barcodes" class="grid"></div>
</main>

<script>
const MM_TO_PX = 3.78;
const code39Map = {
'0':'nnnwwnwnn','1':'wnnwnnnnw','2':'nnwwnnnnw','3':'wnwwnnnnn','4':'nnnwwnnnw',
'5':'wnnwwnnnn','6':'nnwwwnnnn','7':'nnnwnnwnw','8':'wnnwnnwnn','9':'nnwwnnwnn',
'A':'wnnnnwnnw','B':'nnwnnwnnw','C':'wnwnnwnnn','D':'nnnnwwnnw','E':'wnnnwwnnn',
'F':'nnwnwwnnn','G':'nnnnnwwnw','H':'wnnnnwwnn','I':'nnwnnwwnn','J':'nnnnwwwnn',
'K':'wnnnnnnww','L':'nnwnnnnww','M':'wnwnnnnwn','N':'nnnnwnnww','O':'wnnnwnnwn',
'P':'nnwnwnnwn','Q':'nnnnnnwww','R':'wnnnnnwwn','S':'nnwnnnwwn','T':'nnnnwnwwn',
'U':'wwnnnnnnw','V':'nwwnnnnnw','W':'wwwnnnnnn','X':'nwnnwnnnw','Y':'wwnnwnnnn',
'Z':'nwwnwnnnn','-':'nwnnnnwnw','.':'wwnnnnwnn',' ':'nwwnnnwnn','$':'nwnwnwnnn',
'/':'nwnwnnnwn','+':'nwnnnwnwn','%':'nnnwnwnwn','*':'nwnnwnwnn'
};

let generated = [];

/* ---------- Helpers ---------- */
function escapeXML(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;'); }
function escapeTextForHTML(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- Rendering ---------- */
async function renderBarcodes(data){
    const container = document.getElementById('barcodes');
    container.innerHTML = '';
    generated = [];

    for (let i = 0; i < data.length; i++) {
        const item = data[i];
        const type = item.type || document.getElementById('typeSelect').value || 'barcode';
        const stored = { name: item.name || ('code'+(i+1)), code: item.code, type };
        generated.push(stored);

        const card = document.createElement('div');
        card.className = 'card';

        let svgPreview = '';
        if (type === 'barcode') {
            svgPreview = generateCode39SVGString(item.code, 55, 11, true);
        } else {
            svgPreview = await generateQRCodeSVGString(item.code, 55);
        }

        card.innerHTML = `${svgPreview}<p style="margin-top:.5rem; font-size:.9rem;">${escapeTextForHTML(item.name)}</p>`;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn'; deleteBtn.textContent = '×';
        deleteBtn.onclick = () => { removeBarcode(i); };
        card.appendChild(deleteBtn);

        const dlBtn = document.createElement('button');
        dlBtn.className = 'btn';
        dlBtn.style.marginTop = '8px';
        dlBtn.textContent = 'Download PDF';
        dlBtn.onclick = () => downloadSinglePDF(stored);
        card.appendChild(dlBtn);

        container.appendChild(card);
    }
}

/* ---------- Barcode/QR SVG Preview (UI only) ---------- */
function generateCode39SVGString(value,widthMm=55,heightMm=11,showText=true){
    value=`*${value.toUpperCase()}*`;
    const barHeight = heightMm * MM_TO_PX;
    const wide=3; const units=[];
    for(const c of value){ const p=code39Map[c]; if(!p)continue; for(let i=0;i<p.length;i++) units.push(p[i]==='n'?1:wide); units.push(1);}
    units.pop();
    const totalUnits = units.reduce((a,b)=>a+b,0)||1;
    const widthPx = widthMm*MM_TO_PX; const unitWidth = widthPx/totalUnits;
    let x=0; const bars=[];
    for(const c of value){ const p=code39Map[c]; if(!p)continue; for(let i=0;i<p.length;i++){ const w=(p[i]==='n'?1:wide)*unitWidth; if(i%2===0)bars.push(`<rect x="${x.toFixed(2)}" y="0" width="${w.toFixed(2)}" height="${barHeight.toFixed(2)}" fill="black"/>`); x+=w;} x+=unitWidth;}
    const svgHeight=barHeight+(showText?12:0);
    return `<svg xmlns="http://www.w3.org/2000/svg" width="${widthPx}" height="${svgHeight}" viewBox="0 0 ${widthPx} ${svgHeight}"><rect width="100%" height="100%" fill="white"/>${bars.join('')}${showText?`<text x="${(widthPx/2).toFixed(2)}" y="${(barHeight+10).toFixed(2)}" font-size="10" text-anchor="middle" fill="black">${escapeXML(value.replace(/\*/g,''))}</text>`:''}</svg>`;
}

async function generateQRCodeSVGString(value, widthMm=55) {
    const sizePx = widthMm * MM_TO_PX;
    try {
        return await QRCode.toString(value, {
            type: 'svg',
            margin: 0,
            width: sizePx,
            color: { dark: '#000000', light: '#ffffff' } // black & white
        });
    } catch (e) {
        console.error("QR generation failed", e);
        return `<svg width="${sizePx}" height="${sizePx}" xmlns="http://www.w3.org/2000/svg">
            <rect width="100%" height="100%" fill="#fff"/>
            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="12" fill="#f00">QR ERROR</text>
        </svg>`;
    }
}

/* ---------- CSV Upload ---------- */
document.getElementById('csvFile').addEventListener('change',e=>{
    const file = e.target.files[0];
    if(!file)return;
    Papa.parse(file,{ header:true, skipEmptyLines:true, complete: results=>{
        const type=document.getElementById('typeSelect').value;
        const rows = results.data.map(r=>({ name: r['Name']||r['name']||r['Label']||'', code:r['Barcode']||r['barcode']||r['Code']||r['code']||'', type }));
        renderBarcodes(rows.filter(r=>r.name&&r.code));
        e.target.value='';
    }});
});

/* ---------- Manual Add / Remove ---------- */
function addManual(){
    const name=document.getElementById('manualName').value.trim();
    const code=document.getElementById('manualCode').value.trim();
    const type=document.getElementById('typeSelect').value;
    if(!name||!code){alert('Please enter both Name and Code');return;}
    renderBarcodes([...generated.map(g=>({name:g.name,code:g.code,type:g.type})), {name,code,type}]);
    document.getElementById('manualName').value=''; document.getElementById('manualCode').value='';
}
function removeBarcode(index){ generated.splice(index,1); renderBarcodes(generated);}
function clearAll(){ generated=[]; renderBarcodes([]);}

/* ---------- PDF Generation ---------- */
async function drawQRCodePDF(pdf, code, sizeMm, offsetX = 0, offsetY = 0) {
    const qr = QRCode.create(code, { errorCorrectionLevel: 'H' });
    const modules = qr.modules;
    const moduleCount = modules.size;
    const moduleSize = sizeMm / moduleCount;

    pdf.setFillColor(0, 0, 0, 100, 'CMYK'); // Black CMYK
    for (let row = 0; row < moduleCount; row++) {
        for (let col = 0; col < moduleCount; col++) {
            if (modules.get(row, col)) {
                pdf.rect(offsetX + col * moduleSize, offsetY + row * moduleSize, moduleSize, moduleSize, 'F');
            }
        }
    }
}

function drawCode39PDF(pdf, code, widthMm, heightMm, showText = true, offsetX = 0, offsetY = 0) {
    code = `*${code.toUpperCase()}*`;
    const barHeight = heightMm;
    const wide = 3;
    const units = [];

    for (const c of code) {
        const p = code39Map[c];
        if (!p) continue;
        for (let i = 0; i < p.length; i++) units.push(p[i] === 'n' ? 1 : wide);
        units.push(1);
    }
    units.pop();
    const totalUnits = units.reduce((a, b) => a + b, 0) || 1;
    const unitWidth = widthMm / totalUnits;

    let x = offsetX;
    for (const c of code) {
        const p = code39Map[c];
        if (!p) continue;
        for (let i = 0; i < p.length; i++) {
            const w = (p[i] === 'n' ? 1 : wide) * unitWidth;
            if (i % 2 === 0) {
                pdf.setFillColor(0, 0, 0, 100, 'CMYK'); // Black CMYK
                pdf.rect(x, offsetY, w, barHeight, 'F');
            }
            x += w;
        }
        x += unitWidth;
    }

    if (showText) {
        pdf.setFontSize(10);
        pdf.setTextColor(0, 0, 0, 100, 'CMYK');
        pdf.text(code.replace(/\*/g, ''), offsetX + widthMm / 2, offsetY + barHeight + 4, { align: 'center' });
    }
}

async function downloadSinglePDF(item) {
    if (!item || !item.code) { alert('No code to download'); return; }

    const { jsPDF } = window.jspdf;
    const widthMm = parseFloat(document.getElementById('widthMm').value) || 55;
    const heightMm = parseFloat(document.getElementById('heightMm').value) || 11;
    const qrSize = parseFloat(document.getElementById('qrSizeMm').value) || 55;
    const showText = document.getElementById('showText').checked;

    if (item.type === 'barcode') {
        const textHeight = showText ? 5 : 0;
        const pdfHeight = heightMm + textHeight;
        const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [widthMm, pdfHeight] });
        drawCode39PDF(pdf, item.code, widthMm, heightMm, showText);
        const filename = ((document.getElementById('nameWithCode').checked ? `${item.name} ${item.code}` : item.name) || 'code').replace(/[^a-z0-9_\-\.]/gi, '_') + '.pdf';
        pdf.save(filename);
    } else {
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [qrSize, qrSize] });
        await drawQRCodePDF(pdf, item.code, qrSize);
        const filename = ((document.getElementById('nameWithCode').checked ? `${item.name} ${item.code}` : item.name) || 'qrcode').replace(/[^a-z0-9_\-\.]/gi, '_') + '.pdf';
        pdf.save(filename);
    }
}

async function downloadAllPDFs() {
    if (!generated.length) { alert('No codes generated'); return; }
    for (const item of generated) { await downloadSinglePDF(item); }
}

/* ---------- CSV Template ---------- */
function downloadTemplate(){
    const csvContent='Name,Barcode\nExample A,ABC123\nExample B,12345\n';
    const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});
    saveAs(blob,'code_template.csv');
}

/* ---------- Init ---------- */
renderBarcodes([]);
</script>

</body>
</html>
